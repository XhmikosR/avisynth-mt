<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html lang="ru">
<head>
<meta http-equiv="Content-Language" content="ru">
   <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
   <title>DirectShowSource Avisynth Filter</title>
   <link rel="stylesheet" type="text/css" href="../../avisynth.css">
<!--
Automatically generated, don't change:
$Id: directshowsource.htm,v 1.10 2008/12/10 18:52:28 fizick Exp $
-->
</head>
<body >
<h2>
<a NAME="DirectShowSource"></a>DirectShowSource
</h2>

<p><code>DirectShowSource </code>(<var>string filename, float &quot;fps&quot;, bool "seek",
bool &quot;audio&quot;, bool &quot;video&quot;, bool &quot;convertfps&quot;, bool
&quot;seekzero&quot;, int &quot;timeout&quot;, string &quot;pixel_type&quot;, int 
&quot;framecount&quot;, string &quot;logfile&quot;, int &quot;logmask&quot;</var>)</p>

<p><code>DirectShowSource</code> считывает файл <i><var>filename</var></i>, используя DirectShow,
 ту же систему воспроизведения мультимедия, которую использует Windows Media Player. 
 Может считывать большинство форматов, которые может воспроизводить Media Player,
  включая MPEG, MP3, и QuickTime, также как AVI файлы, которые <tt>AVISource</tt> не поддерживает 
  (такие как DV тип 1, или файлы, использующие только DirectShow кодеки). 
  Сначала надо попробовать считать AVI файлы с помощью <tt>AVISource</tt>, и если не заработает,
   тогда попробовать вместо него этот фильтр.</p>
<p>Некоторые предостережения:
<ul>

<li>
Некоторые декодеры (особенно MS MPEG-4) будут производить перевернутое по вертикали видео.
 Необходимо использовать <code><a href="flip.htm">FlipVertical</a></code>. </li>

<li>DirectShow видео декодеры не обязательно поддерживают покадрово точный поиск. 
В большинстве случаев поиск будет работать, но в некоторых может не работать.</li>

<li>DirectShow даже не обязательно сообщают точную частоту кадров входящего видео.
 Многие сообщают, но ASF декодер не сообщает. 
 Необходимо указать частоту кадров, используя параметр fps , в виде <code>DirectShowSource</code>
("video.asf", fps=15).</li>

<li>Эта версия автоматически детектирует Microsoft DV кодек
 и настраивает его на декодирование в полном (вместо половинного) разрешения. Я предполагаю 
нет протестов :-)</li>
<li>Также эта версия пытается отменить любой деинтерлейс в декодере.</li>
</ul>
</p>

<p><var>fps</var>: Иногда необходимо указать частоту кадров видео.
 Если частота кадров или число кадров некорректны (это может случиться с asf или mov клипами),
 используйте эту опцию, чтобы установить корректную частоту кадров.</p>
<p><var>seek</var> = true (с <em>v2.53</em>): Полная поддержка поиска (доступная на большинстве форматов файлов). 
Если случатся проблемы, попытайтесь сначала разрешить опцию <var>seekzero</var>, если поиск все еще вызывает проблемы, 
полностью отмените поиск. С отмененным поиском, аудиопоток возвращает тишину, а видео поток - последний обработанный кадр, 
если попытаться делать поиск назад. Отметьте, что кэш Avisynth может обеспечить ограниченный доступ к нескольким 
предыдущим кадрам, за которыми будет возвращен последний обработанный кадр.</p>
<p><var>audio</var> = true (с <em>v2.53</em>): Поддержка звука в DirectShowSource. <code>DirectShowSource</code>
   может открывать такие форматы как WAV/DTS/AC3/MP3, при условии, что их можно воспроизвести например в WMP 
   (более точно: при условии, что они рендерятся корректно в GraphEdit). 
   Порядок каналов такой же как в <cite><a href="http://www.cs.bath.ac.uk/~jpff/NOS-DREAM/researchdev/wave-ex/wave_ex.html">
   wave-format-extensible</a></cite> (расширяемом WAV)формате, т.к. вход всегда декомпрессируется в WAV.
    Для большей информации см также <a href="getchannel.htm"><code>GetChannel</code></a>. 
    AviSynth загружает 8, 16, 24 и 32 бит целые PCM (ИКМ) аудио отсчеты, и аудио формат с плавающей точкой, и любое количество каналов.  </p>

<p><var>video</var> = true (с <em>v2.52</em>): Если установлено в false, это позволяет открыть только аудио.</p>
<p><var>convertfps</var> = false (с <em>v2.56</em>): Преобразует переменную частоту кадров (vfr) в постоянную частоту кадров (cfr), добавляя кадры.
Это полезно, когда надо открыть видео с переменой частотой кадров (например mkv, rmvb, mp4, asf или wmv с гибридным видео) в AviSynth. 
Это наиболее полезно, если параметр <var>fps</var> установлен в наименьший общий множитель 
компонент vfr скоростей, например 120 или 119.880</p>
<p><var>seekzero</var> = false (с <em>v2.56</em>): Опция ограничивающая поиск только назад к началу. 
Это допускает ограниченный поиск с неидексированными файлами ASF. Поиск вперед - это конечно сделано трудным способом.</p>
<p><var>timeout</var> = 60000 (в миллисекундах; 60000 ms = 1 мин) (с <em>v2.56</em>): Чтобы установить время 
 ожидания, когда DirectShow отказывается рендерить. Положительные величины возвращают пустые кадры видео и тишину аудио потоков. 
 Отрицательные величины вызывают Avisynth исключение во время выполнения.</p>
<p><var>pixel_type</var> (с <em>v2.56</em>): Тип пиксела результирующего клипа,
 он может быть "YV12", "YUY2", "ARGB", "RGB32", "RGB24", "YUV", "RGB" или "AUTO".
 По умолчанию, расположенные выше по течению DirectShow фильтры свободны предложить все ими
поддерживаемые медиафоматы в ими самими определямом порядке. Некоторые DirectShow
фильтры делают это неверно. 
 <var>pixel_type</var> ограничивает допустимый субформат видеопотока для согласования входного вывода (IPin).
 Заметьте, что построитель графа может добавить конвертер формата, чтобы выполнить ваш запрос,
 так что удостоверьтесь, что используемый кодек может действительно декодировать в выбранный вами формат.
 Конвертер форматов M$ как раз достаточен. "YUV" и "RGB"
псевдо-типы ограничивают согласование до всех поддерживаемых yuv или rgb форматов соответственно.
Псевдо-тип "AUTO" разрешает при согласовании
использовать все подходящие форматы в следующем порядке предпочтения:
YV12, YUY2, ARGB, RGB32, RGB24. Многие DirectShow фильтры делают это неверно, вот почему
это не сделано по умолчанию. Данная опция существует, чтобы дать Вам достаточно возможностей
содействовать максимальному сортаменту фильтров обслужить Ваши медиа файлы. 
(Смотри <a href="http://forum.doom9.org/showthread.php?t=143321">обсуждение</a>.)</p>

<p><var>framecount</var> (с <em>v2.57</em>): Иногда надо указать 
число кадров видео. Если частота кадров или число кадров некорректны (это
может случиться с клипами asf или mov), используйте эту опцию, чтобы назначить коректное число
кадров. Если также указана <var>fps</var>, то длина аудиопотока также
подгоняется.</p>
<p><var>logfile</var> (с <em>v2.57</em>): Используйте эту опцию, чтобы указать имя
отладочного лог-файла протокола.</p>
<p><var>logmask</var> = 35 (с <em>v2.57</em>): Если указан лог-файл, используйте эту опцию,
чтобы выбрать, какая информация протоколируется.
<center><table border="1">
<tr><th align=right>Величина</th><th>Данные</th></tr>
<tr><td align=right>  1</td><td>Согласование формата (Format Negotiation)</td></tr>
<tr><td align=right>  2</td><td>Полученные отсчеты (Receive samples)</td></tr>
<tr><td align=right>  4</td><td>Вызовы кадров/аудио (GetFrame/GetAudio calls)</td></tr>
<tr><td align=right>  8</td><td>Обратные вызовы Directshow (Directshow callbacks)</td></tr>
<tr><td align=right> 16</td><td>Запросы к Directshow (Requests to Directshow)</td></tr>
<tr><td align=right> 32</td><td>Ошибки (Errors)</td></tr>
<tr><td align=right> 64</td><td>Счет использования объектов COM (COM object use count)</td></tr>
<tr><td align=right>128</td><td>Новые объекты (New objects)</td></tr>
<tr><td align=right>256</td><td>Дополнительная информация (Extra info)</td></tr>
<tr><td align=right>512</td><td>Случаи ожидания (Wait events)</td></tr>
</table></center>
Сложите вместе величины для данных, которые Вы хотите протоколировать. Укажите -1 чтобы протоколировать все.
По умолчанию 35 - Format Negotiation, Received samples и Errors, то есть 1+2+32</p>
<h3>Примеры</h3>
<p>Открывает avi как первый доступный RGB формат (без аудио):</p>
<pre>DirectShowSource("F:\TestStreams\xvid.avi",fps=25, audio=false, pixel_type="RGB")</pre>
<p>Открывает DV клип, используя MS DV декодер:</p>
<pre>DirectShowSource("F:\DVCodecs\Analysis\Ced_dv.avi") # MS-DV</pre>
<p>Открывает mkv c переменной частотой кадров как 119.88 к/с путем добавления кадров (обеспечивая синхронизацию):</p>
<pre>DirectShowSource("F:\Guides\Hybrid\vfr_startrek.mkv", fps=119.88, convertfps=true)</pre>
<p>Открывает realmedia *rmvb клип:</p>
<pre>DirectShowSource("F:\test.rmvb", fps=24, convertfps=true)</pre>
<p>Открывает файл GraphEdit:</p>
<pre>V=DirectShowSource(&quot;F:\vid_graph.grf&quot;, audio=False) # только видео (аудио отменено)
A=DirectShowSource(&quot;F:\aud_graph.grf&quot;, video=False) # только аудио (видео отменено)
AudioDub(V, A)</pre>
<p>Смотри ниже некоторые примеры с аудио.</p>

<h3>Устранение видео и аудио проблем</h3>
<p>AviSynth по умолчанию будет пытаться открыть только медиа (компоненты), которые он может открыть без проблем.
 Если какой-либо компонент не может быть открыт, он просто не будет добавлен в выход.
  Это также означает, что если есть проблема, Вы не увидите ошибки. 
  Для получения сообщения о ошибке отсутствующего компонента, используйте audio=false или video=false 
  и запретите компонент, который на самом деле работает. 
  В этом случае AviSynth выведет сообщение о компоненте, который не работает.
</p>

<h4>&quot;RenderFile, the Filter Graph won't talk to me&quot; ("Фильтерграф не говорит со мной", сообщение)</h4>
<p>Это общая ошибка, которая происходит, когда DirectShow не может предоставить никакой формат, читаемый AviSynth.
 Попробуйте создание фильтерграфа вручную и проверьте, есть ли возможность создания фильтерграфа, 
 который предоставляет какой-либо выход, который AviSynth может открыть. 
 Если не получается, то по всей видимости необходимы дополнительные DirectShow фильтры,
  которые могут предоставлять корректный материал.
</p>

<h4>Скорость отсчетов не верна !</h4>
<p>Некоторые фильтры по всей видимости имеют проблемы с сообщением правильной скорости следования отсчетов,
 и тогда корректируют это во время реального воспроизведения файла.
  К сожалению нет способа для AviSynth скорректировать это после того, как файл был открыт.
   Используйте <a href="assumerate.htm">AssumeSampleRate</a>
    и установить правильную скорость отсчетов для устранения этой проблемы.
</p>

<h4>Мой звук неустойчивый</h4>
<p>К несчастью DirectShow не требует поддержки точного поиска отсчетов.
 Откройте звук другим методом или отделите звук (demux) видео файла и подайте его в AviSynth другим методом.
  Иначе можно указать &quot;seekzero = true&quot; или &quot;seek = false&quot; как параметры или использовать 
<a href="ensuresync.htm">EnsureVBRMP3Sync</a> фильтр чтобы вынудить линейный доступ
к Directshow аудио потоку.</p>

<h4>Мои  проигрывания ASF начинаются быстро и заканчиваются медленно</h4>
<p>Microsoft в их бесконечной мудрости решила реализовать установление времени ASF потока в
ASF разделителе (демуксере). A в результате невозможно раздеть файлы ASF формата быстрее, чем
в реальное время. Это наиболее видно, когда  вы сначала начинаете обрабатывать
потоки; обычно после открытия Avisynth скрипта Вам требуется некоторое время, 
чтобы сконфигурировать
ваш видеоредактор, все это время смеситель накапливает
<i>кредит</i> времени. Когда Вы затем начинаете обработку потока, он бежит  с
максимальной скоростью, пока вы не догоните реальное время, в этой точке он замедляется
до реальной скорости материала источнмка. Эта особенность делает невозможным использовать 
Avisynth чтобы пересчитать 24fps ASF материал в 25fps для прямого проигрывания PAL.</p>

<h3>Общие задачи</h3>
<p>Этот раздел описывает разные задачи, которые могут не быть 100% очевидными. :) 
</p>

<h4>Открытие GRF файлов</h4>
<p>GRF-файлы GraphEdit (редактор графов, ГрафЭдит) автоматически детектируются по расширению .grf 
и прямо загружаются DirectShowSource.
 Чтобы AviSynth мог подсоединиться к нему, необходимо в GraphEdit оставить открытыми пины (соединительные точки) тех медиа типов,
  к которым AviSynth может подсоединиться. 
  AviSynth не будет пытаться отсоединять никакие фильтры, так что важно, чтобы выходной тип был правильный.
DirectShowSource принимает только
YV12, YUY2, ARGB, RGB32 и RGB24 видео форматы и 32, 24, 16 и 8-битные PCM
и IEEE FLOAT аудио форматы.</p>
<p>Данный GRF-файл должен выводить только один аудио или видео поток, чтобы избежать
недоразумения, когда DirectShowSource пытается соединиться к вашему открытому пину (-ам).
С версии 2.57 это однопотоковое ограничение обязательно.</p>

<h4>Смешивание каналов (downmixing) АС3 в стерео</h4>
По существу есть два пути сделать это.
 Первый это установить смешивание каналов (downmixing) в конфигурации собственно используемого АС3 декодера, 
 и второй это использование внешнего смесителя каналов (downmixer) от &quot;Trombettworks&quot;:
<p>1) Установите АС3filter. Откройте АС3 файл в WMP6.4 и выберите меню о свойствах файла. 
Установить выход АС3filter на <b>2/0 - stereo</b>.
 Если хочется наилучшее возможное качество, выбрать PCM Float 
 (ИКМ с отсчетами в виде чисел с плавающей точкой) как Sample format (формат отсчетов).</p>
<img border="0" src="../pictures/corefilters/ac3downmix1a.jpg" width="425" height="435">
<img border="0" src="../pictures/corefilters/ac3downmix1b.jpg" width="628" height="487">
<p>Сделайте следующий скрипт-файл:
<pre>v = Mpeg2Source(&quot;e:\movie.d2v&quot;)
a = DirectShowSource(&quot;e:\Temp\Test2\test.ac3&quot;)
AudioDub(v,a)</pre>
В заключение, откройте этот скрипт в VirtualDub и сконвертируйте аудио поток в МР3 
(конечно можно также отделить (demux) этот сокращенный WAV поток, если необходимо).

<p>2) Зарегистрируйте DirectShow фильтр <a href="http://www.trombettworks.com/directshow.php"><cite>Channel
Downmixer by Trombettworks</cite></a> (в Пуск -> Выполнить...):
</p>
<p>&nbsp;&nbsp;&nbsp; <i>regsvr32 ChannelDownmixer.ax</i>

<p>Откройте АС3 файл в WMP6.4 и выберите меню о свойствах файла. Установите выход AC3Filter на <b>3/2+SW 5.1 channels</b> 
(этот смеситель каналов не может работать с PCM Float, так что здесь выбран РСМ 16 бит).
 В свойствах смесителя число входных и выходных каналов должно быть определено автоматически.
  Проверьте, что это действительно правильно.
<br><br>
<img border="0" src="../pictures/corefilters/ac3downmix2a.jpg" width="425" height="435">&nbsp;
<img border="0" src="../pictures/corefilters/ac3downmix2b.jpg" width="628" height="487">

<p> <img border="0" src="../pictures/corefilters/ac3downmix2c.jpg" width="695" height="595">

<p>Сделайте следующий скрипт:
<pre>v = Mpeg2Source(&quot;e:\movie.d2v&quot;)
a = DirectShowSource(&quot;e:\Temp\Test2\test.ac3&quot;)
AudioDub(v,a)</pre>
В заключение, откройте этот скрипт в VirtualDub и сконвертируйте аудио поток в МР3 
(конечно можно также отделить (демуксировать, demux) сокращенный WAV поток если необходимо).
<p>По какой-то причине у меня не получается запустить это в работу с DTS потоками :(</p>

<p><b>Изменения</b></p>
<table border="1" width="40%">
  <tr>
    <td rowspan=4 width="5%">v2.56</td>
    <td width="50%">convertfps преобразует vfr в постоянный cfr добавлением кадров</td>
  </tr>
  <tr>
    <td width="50%">seekzero ограничивает поиск к началу только</td>
  </tr>
  <tr>
    <td width="50%">timeout управляет откликом на непокорные графы</td>
  </tr>
  <tr>
    <td width="50%">pixel_type указывает/ограничивает формат пиксела выходного видео</td>
  </tr>
  <tr>
    <td rowspan=2 width="5%">v2.57</td>
    <td width="50%">framecount переопределяет длину потоков.</td>
  </tr>
  <tr>
    <td width="50%">logfile и logmask указывают отладочное протоколирование.</td>
  </tr>
</table>

<p><kbd>
$English Date: 2008/12/07 15:47:16 $ <br>
Русский перевод 09.05.2005 Drakon Rider <a href="http://drakan.ru">drakan.ru</a><br>
Обновил 26.09.2005-10.12.2008 Fizick <a href="http://avisynth.org.ru">avisynth.org.ru</a>
</kbd></p>
<form><input TYPE="Button" VALUE="Назад" onClick="history.go(-1)"></form>
</body>
</html>